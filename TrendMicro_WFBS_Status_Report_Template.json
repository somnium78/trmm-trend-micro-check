{
  "base_template": {
    "name": "TRMM_Base v1",
    "html": "<html>\n\n<head>\n    <style>\n        /* —— PDF page settings —— */\n        @page {\n            margin: 0.5in;\n        }\n\n        /* —— Color palette (theme) —— */\n        :root {\n            --header-bg: #2c3e50;\n            --header-text: #ffffff;\n            --border-color: #dddddd;\n            --table-header-bg: #f2f2f2;\n            --status-ready-bg: #eaf7ec;\n            --status-ready-badge: #28a745;\n            --status-not-ready-bg: #fbebee;\n            --status-not-ready-badge: #dc3545;\n            --status-unknown-bg: #fff9e6;\n            --status-unknown-badge: #ffc107;\n            --badge-already-bg: #17a2b8;\n        }\n\n        /* —— Typography & utilities (structure) —— */\n        body {\n            font-family: sans-serif;\n            color: #333;\n        }\n\n        .section {\n            margin-top: 20px;\n        }\n\n        .text-danger {\n            color: var(--status-not-ready-badge);\n            font-weight: bold;\n        }\n\n        /* —— Header layout (structure) —— */\n        .report-header {\n            background-color: var(--header-bg);\n            color: var(--header-text);\n            padding: 20px;\n            border-radius: 8px;\n            display: flex;\n            align-items: center;\n        }\n\n        .header-logo {\n            width: 80px;\n            margin-right: 25px;\n            flex-shrink: 0;\n        }\n\n        .header-date {\n            margin-left: auto;\n            text-align: right;\n            white-space: nowrap;\n        }\n\n        .report-header h1 {\n            font-size: 24px;\n            margin: 0 0 5px;\n        }\n\n        .report-header h2 {\n            font-size: 16px;\n            margin: 0;\n            opacity: 0.9;\n        }\n\n        /* —— Table basics (structure) —— */\n        .report-table {\n            border-collapse: collapse;\n            width: 100%;\n            font-size: 12px;\n        }\n\n        .report-table th,\n        .report-table td {\n            border: 1px solid var(--border-color);\n            padding: 8px 12px;\n            text-align: left;\n            vertical-align: middle;\n        }\n\n        .report-table thead th {\n            background-color: var(--table-header-bg);\n            font-weight: bold;\n        }\n\n        /* —— Badge shape (structure) —— */\n        .status-badge {\n            display: inline-block;\n            padding: 4px 10px;\n            border-radius: 12px;\n            color: #fff;\n            font-weight: bold;\n            font-size: 11px;\n            text-align: center;\n            white-space: nowrap;\n        }\n\n        /* —— Stub classes for per‑report overrides —— */\n        .status-ready {}\n\n        .status-not-ready {}\n\n        .status-unknown {}\n\n        .badge-ready {}\n\n        .badge-not-ready {}\n\n        .badge-unknown {}\n\n        .badge-already {}\n    </style>\n</head>\n\n<body>\n    {% block content %}{% endblock %}\n</body>\n\n</html>"
  },
  "template": {
    "name": "Trend Micro WFBS Status Report",
    "template_css": "",
    "template_md": "{% block content %}\n<style>\n  @page {\n    margin: 0.5in;\n    size: letter landscape;\n    /* or A4 landscape */\n  }\n\n  /* —— Only per‑report row & badge colors —— */\n  .status-healthy {\n    background-color: var(--status-ready-bg);\n  }\n\n  .status-warning {\n    background-color: var(--status-not-ready-bg);\n  }\n\n  .status-critical {\n    background-color: var(--status-unknown-bg);\n  }\n\n  .status-unknown {\n    background-color: #f8f9fa;\n  }\n\n  .badge-healthy {\n    background-color: var(--status-ready-badge);\n  }\n\n  .badge-warning {\n    background-color: var(--status-not-ready-badge);\n  }\n\n  .badge-critical {\n    background-color: var(--status-unknown-badge);\n    color: #333;\n  }\n\n  .badge-unknown {\n    background-color: #6c757d;\n    color: white;\n  }\n\n  .protection-enabled {\n    background-color: var(--status-ready-badge);\n    color: white;\n  }\n\n  .protection-disabled {\n    background-color: var(--status-not-ready-badge);\n    color: white;\n  }\n</style>\n\n<div class=\"report-header\">\n  <div class=\"header-logo\">\n    <img src=\"https://github.com/amidaware/reporting-templates/blob/master/assets/gbtnavy%20(256).png?raw=true\" alt=\"Amidaware Logo\" style=\"width: 80px; height: auto;\">\n  </div>\n  <div class=\"header-titles\">\n    <h1>Trend Micro WFBS Status Report</h1>\n    <h2>Client: {{ client.name }}</h2>\n  </div>\n  <div class=\"header-date\">\n    <h2>Report Date:<br>{{ report_run_timestamp.strftime('%B %d, %Y') }}</h2>\n  </div>\n</div>\n\n<div class=\"section\">\n  <table class=\"report-table\">\n    <thead>\n      <tr>\n        <th>Client</th>\n        <th>Site</th>\n        <th>Device Name</th>\n        <th>Operating System</th>\n        <th style=\"text-align: center;\">TM Status</th>\n        <th style=\"text-align: center;\">Installed</th>\n        <th style=\"text-align: center;\">Service</th>\n        <th style=\"text-align: center;\">Signature Age</th>\n        <th style=\"text-align: center;\">Last Update</th>\n      </tr>\n    </thead>\n    <tbody>\n      {% set healthy_devices, warning_devices, critical_devices, unknown_devices = [], [], [], [] %}\n\n      {% for agent in data_sources.trend_micro_data %}\n      {% if agent.custom_fields.trend_micro_status %}\n        {% if '\"health_status\":\"OK\"' in agent.custom_fields.trend_micro_status %}\n          {% set _ = healthy_devices.append(agent) %}\n        {% elif '\"health_status\":\"REALTIME_DISABLED\"' in agent.custom_fields.trend_micro_status %}\n          {% set _ = healthy_devices.append(agent) %}\n        {% elif '\"health_status\":\"UNKNOWN\"' in agent.custom_fields.trend_micro_status %}\n          {% set _ = unknown_devices.append(agent) %}\n        {% else %}\n          {% set _ = critical_devices.append(agent) %}\n        {% endif %}\n      {% else %}\n        {% set _ = unknown_devices.append(agent) %}\n      {% endif %}\n      {% endfor %}\n\n      {% set sorted_devices = (critical_devices | sort(attribute='hostname') | sort(attribute='site__name')) +\n                              (warning_devices | sort(attribute='hostname') | sort(attribute='site__name')) +\n                              (unknown_devices | sort(attribute='hostname') | sort(attribute='site__name')) +\n                              (healthy_devices | sort(attribute='hostname') | sort(attribute='site__name')) %}\n\n      {% for agent in sorted_devices %}\n      {% set row_class = 'status-unknown' %}\n      {% set badge_class = 'badge-unknown' %}\n      {% set status_text = 'No Data' %}\n      {% set installed_status = 'N/A' %}\n      {% set service_status = 'N/A' %}\n      {% set protection_status = 'N/A' %}\n      {% set protection_class = 'badge-unknown' %}\n      {% set signature_age = 'N/A' %}\n      {% set last_update = 'N/A' %}\n\n      {% if agent.custom_fields.trend_micro_status %}\n        {% if '\"health_status\":\"OK\"' in agent.custom_fields.trend_micro_status %}\n          {% set row_class = 'status-healthy' %}\n          {% set badge_class = 'badge-healthy' %}\n          {% set status_text = 'Healthy' %}\n        {% elif '\"health_status\":\"REALTIME_DISABLED\"' in agent.custom_fields.trend_micro_status %}\n          {% set row_class = 'status-healthy' %}\n          {% set badge_class = 'badge-healthy' %}\n          {% set status_text = 'Healthy' %}\n        {% elif '\"health_status\":\"UNKNOWN\"' in agent.custom_fields.trend_micro_status %}\n          {% set row_class = 'status-unknown' %}\n          {% set badge_class = 'badge-unknown' %}\n          {% set status_text = 'Not Installed' %}\n        {% else %}\n          {% set row_class = 'status-critical' %}\n          {% set badge_class = 'badge-critical' %}\n          {% set status_text = 'Critical' %}\n        {% endif %}\n\n        {% if '\"installed\":1' in agent.custom_fields.trend_micro_status %}\n          {% set installed_status = '✅' %}\n        {% else %}\n          {% set installed_status = '❌' %}\n        {% endif %}\n\n        {% if '\"service_running\":1' in agent.custom_fields.trend_micro_status %}\n          {% set service_status = '✅' %}\n        {% else %}\n          {% set service_status = '❌' %}\n        {% endif %}\n\n        {% if '\"realtime_protection\":1' in agent.custom_fields.trend_micro_status %}\n          {% set protection_status = 'Enabled' %}\n          {% set protection_class = 'protection-enabled' %}\n        {% else %}\n          {% set protection_status = 'Disabled' %}\n          {% set protection_class = 'protection-disabled' %}\n        {% endif %}\n\n        {% if '\"signature_age\":0.' in agent.custom_fields.trend_micro_status %}\n          {% set signature_age = '< 1 day' %}\n        {% elif '\"signature_age\":1.' in agent.custom_fields.trend_micro_status %}\n          {% set signature_age = '~1 day' %}\n        {% elif '\"signature_age\":-1' in agent.custom_fields.trend_micro_status %}\n          {% set signature_age = 'Unknown' %}\n        {% else %}\n          {% set signature_age = '> 1 day' %}\n        {% endif %}\n\n        {% if '\"last_update\":\"2025-07-28\"' in agent.custom_fields.trend_micro_status %}\n          {% set last_update = 'Today' %}\n        {% elif '\"last_update\":\"2025-07-27\"' in agent.custom_fields.trend_micro_status %}\n          {% set last_update = 'Yesterday' %}\n        {% elif '\"last_update\":\"Unknown\"' in agent.custom_fields.trend_micro_status %}\n          {% set last_update = 'Unknown' %}\n        {% else %}\n          {% set last_update = 'Outdated' %}\n        {% endif %}\n      {% endif %}\n\n      <tr class=\"{{ row_class }}\">\n        <td>{{ agent.site__client__name or 'N/A' }}</td>\n        <td>{{ agent.site__name or 'N/A' }}</td>\n        <td>\n          <b>{{ agent.hostname or 'N/A' }}</b><br>\n          {% if agent.last_seen %}\n          <small {% if (report_run_timestamp - agent.last_seen).days > 30 %} class=\"text-danger\" {% endif %}>\n              Last Seen: {{ agent.last_seen.astimezone(ZoneInfo('America/New_York')).strftime('%Y-%m-%d %H:%M:%S') }}\n            </small>\n          {% else %}\n          <small>N/A</small>\n          {% endif %}\n        </td>\n        <td style=\"word-wrap: break-word;\">{{ agent.operating_system or 'N/A' }}</td>\n        <td style=\"text-align: center;\">\n          <span class=\"status-badge {{ badge_class }}\">{{ status_text }}</span>\n        </td>\n        <td style=\"text-align: center;\">{{ installed_status }}</td>\n        <td style=\"text-align: center;\">{{ service_status }}</td>\n        <td style=\"text-align: center;\">{{ signature_age }}</td>\n        <td style=\"text-align: center;\">{{ last_update }}</td>\n      </tr>\n      {% endfor %}\n    </tbody>\n  </table>\n</div>\n\n<div class=\"section\">\n  <h3>Summary Statistics</h3>\n  {% set healthy_count = healthy_devices|length %}\n  {% set warning_count = warning_devices|length %}\n  {% set critical_count = critical_devices|length %}\n  {% set unknown_count = unknown_devices|length %}\n  {% set total_count = data_sources.trend_micro_data|length %}\n\n  <div style=\"display: flex; gap: 20px; margin: 20px 0;\">\n    <div style=\"padding: 15px; border-left: 4px solid var(--status-ready-badge); background: var(--status-ready-bg);\">\n      <h4 style=\"margin: 0; color: var(--status-ready-badge);\">✅ Healthy</h4>\n      <p style=\"margin: 5px 0 0 0; font-size: 24px; font-weight: bold;\">{{ healthy_count }}</p>\n      <small>{{ \"%.1f\"|format((healthy_count / total_count * 100) if total_count > 0 else 0) }}%</small>\n    </div>\n    <div style=\"padding: 15px; border-left: 4px solid var(--status-not-ready-badge); background: var(--status-not-ready-bg);\">\n      <h4 style=\"margin: 0; color: var(--status-not-ready-badge);\">⚠️ Warning</h4>\n      <p style=\"margin: 5px 0 0 0; font-size: 24px; font-weight: bold;\">{{ warning_count }}</p>\n      <small>{{ \"%.1f\"|format((warning_count / total_count * 100) if total_count > 0 else 0) }}%</small>\n    </div>\n    <div style=\"padding: 15px; border-left: 4px solid var(--status-unknown-badge); background: var(--status-unknown-bg);\">\n      <h4 style=\"margin: 0; color: var(--status-unknown-badge);\">❌ Critical</h4>\n      <p style=\"margin: 5px 0 0 0; font-size: 24px; font-weight: bold;\">{{ critical_count }}</p>\n      <small>{{ \"%.1f\"|format((critical_count / total_count * 100) if total_count > 0 else 0) }}%</small>\n    </div>\n    <div style=\"padding: 15px; border-left: 4px solid #6c757d; background: #f8f9fa;\">\n      <h4 style=\"margin: 0; color: #6c757d;\">❓ Unknown</h4>\n      <p style=\"margin: 5px 0 0 0; font-size: 24px; font-weight: bold;\">{{ unknown_count }}</p>\n      <small>{{ \"%.1f\"|format((unknown_count / total_count * 100) if total_count > 0 else 0) }}%</small>\n    </div>\n  </div>\n</div>\n\n{% endblock %}",
    "type": "markdown",
    "depends_on": [
      "client"
    ],
    "template_variables": "data_sources:\n  trend_micro_data:\n    custom_fields:\n      - trend_micro_status\n    filter:\n      site__client: '{{ client.id }}'\n    model: agent\n    only:\n      - hostname\n      - site__client__name\n      - site__name\n      - last_seen\n      - operating_system\nreport_run_timestamp: !now"
  },
  "assets": []
}
